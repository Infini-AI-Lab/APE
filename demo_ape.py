import torch
from transformers import AutoTokenizer, AutoModelForCausalLM
import numpy as np
import random
import argparse

def parse_args(args=None):
    parser = argparse.ArgumentParser()
    parser.add_argument('--model', type=str, default=None, choices=["llama3-8b-instruct", "llama3.1-8b-instruct", "mistral-7b-instruct-v0.3", "gemma2-9b-it"])
    parser.add_argument("--temperature", type=float, default=1.0)
    parser.add_argument("--scale", type=float, default=1.0)
    return parser.parse_args(args)

def load_model_and_tokenizer(model_name, device):
    if model_name == "llama3-8b-instruct":
        tokenizer = AutoTokenizer.from_pretrained("meta-llama/Meta-Llama-3-8B-Instruct")
        model = AutoModelForCausalLM.from_pretrained("meta-llama/Meta-Llama-3-8B-Instruct", torch_dtype=torch.bfloat16).to(device)
    elif model_name == "llama3.1-8b-instruct":
        tokenizer = AutoTokenizer.from_pretrained("meta-llama/Llama-3.1-8B-Instruct")
        model = AutoModelForCausalLM.from_pretrained("meta-llama/Llama-3.1-8B-Instruct", torch_dtype=torch.bfloat16).to(device)
    elif model_name == "mistral-7b-instruct-v0.3":
        tokenizer = AutoTokenizer.from_pretrained("mistralai/Mistral-7B-Instruct-v0.3")
        model = AutoModelForCausalLM.from_pretrained("mistralai/Mistral-7B-Instruct-v0.3", torch_dtype=torch.bfloat16).to(device)
    elif model_name == "gemma2-9b-it":
        tokenizer = AutoTokenizer.from_pretrained("google/gemma-2-9b-it")
        model = AutoModelForCausalLM.from_pretrained("google/gemma-2-9b-it", torch_dtype=torch.bfloat16).to(device)
    return tokenizer, model
        

def build_prefix(model_name, prompt):
    if "llama" in model_name:
        prompt = f"<|begin_of_text|>\n<|start_header_id|>user<|end_header_id|>\n{prompt}"
    elif "mistral" in model_name:
        prompt = f"<s>[INST]{prompt}"
    elif "gemma" in model_name:
        prompt = f"<bos><start_of_turn>user\n{prompt}"
    return prompt

def build_suffix(model_name, prompt):
    if "llama" in model_name:
        prompt = f"{prompt}\n<|eot_id|>\n<|start_header_id|>assistant<|end_header_id|>"
    elif "mistral" in model_name:
        prompt = f"{prompt}[/INST]"
    elif "gemma" in model_name:
        prompt = f"{prompt}<end_of_turn>\n<start_of_turn>model\n"   
    return prompt

def enable_attention_prefill_prefix(model_name, model):
    if "llama" in args.model:
        from src.ape_llama import enable_llama_attention_prefill_prefix
        enable_llama_attention_prefill_prefix(model)
    elif "mistral" in model_name:
        from src.ape_mistral import enable_mistral_attention_prefill_prefix
        enable_mistral_attention_prefill_prefix(model)
    elif "gemma" in model_name:
        from src.ape_gemma import enable_gemma_attention_prefill_prefix
        enable_gemma_attention_prefill_prefix(model)

def enable_attention_prefill_context(model_name, model):
    if "llama" in args.model:
        from src.ape_llama import enable_llama_attention_prefill_context
        enable_llama_attention_prefill_context(model)
    elif "mistral" in model_name:
        from src.ape_mistral import enable_mistral_attention_prefill_context
        enable_mistral_attention_prefill_context(model)
    elif "gemma" in model_name:
        from src.ape_gemma import enable_gemma_attention_prefill_context
        enable_gemma_attention_prefill_context(model)

def enable_attention_prefill_query(model_name, model, temperature, scale):
    if "llama" in args.model:
        from src.ape_llama import enable_llama_attention_prefill_query
        enable_llama_attention_prefill_query(model, temperature, scale)
    elif "mistral" in model_name:
        from src.ape_mistral import enable_mistral_attention_prefill_query
        enable_mistral_attention_prefill_query(model, temperature, scale)
    elif "gemma" in model_name:
        from src.ape_gemma import enable_gemma_attention_prefill_query
        enable_gemma_attention_prefill_query(model, temperature, scale)

def seed_everything(seed):
    torch.manual_seed(seed)
    torch.cuda.manual_seed(seed)
    np.random.seed(seed)
    random.seed(seed)
    torch.backends.cudnn.benchmark = False
    torch.backends.cudnn.deterministic = True
    torch.cuda.manual_seed_all(seed)

def generate(args):
    prefix = ""
    contexts = [
        'Passage 1:\nHenry, Lord Paulet\nLord Henry Paulet (1602–1672) was an English courtier who sat briefly in the House of Commons in the 2nd Parliament of Charles I, from February to June 1626. \nPaulet was a son of William Paulet, 4th Marquess of Winchester. On 6 March 1618, he was admitted to Peterhouse, Cambridge. He was created Knight of the Bath at the Coronation of Charles I and was of Amport, Hampshire. In 1626, he was elected as one of the two members of parliament for Andover.Paulet married Lucy Philpot, a daughter of Sir George Philpot. Their son Francis was the grandfather of the twelfth Marquess of Winchester.\n', 'Passage 2:\nLewis Gordon, 3rd Marquess of Huntly\nLewis Gordon, 3rd Marquess of Huntly (c. 1626–1653) was a Scottish nobleman.\nHe was the third son of George Gordon, 2nd Marquess of Huntly.\n\nBiography\nBorn when his father was commander of the Garde Écossaise, he was named after Louis XIII of France, and brought up until the age of ten by his grandfather, George Gordon, 1st Marquess of Huntly. From an early age, he showed himself to be a reckless romantic – while still a child, he stole some jewels and attempted to take ship to Holland, presumably to join the army. When he was thirteen, the First Bishops\' War broke out, and the young nobleman sneaked out of Gordon Castle (one account says he climbed over the wall) and hurried to the Highlands, where he raised a brigade of clansmen from his father\'s estates to fight the Covenanters. His first experience of war was at Megray Hill, where his Highlanders scattered in the face of enemy cannon fire.\nFollowing the peace, Lord Lewis travelled to France, where he enlisted as an ordinary pikeman in an infantry regiment, in order to learn his soldiering from the ground up. After three years, he traveled to England, working his way north by serving on both sides in the English Civil War, first in the royalist army and then in the Scottish Covenanter forces of his uncle, the Earl of Argyll, the same army he had fought against in 1639.\nEventually returning home, the sixteen-year-old nobleman seduced and married the fiancée of his absent elder brother, Viscount Aboyne. He served on both sides in the Scottish Civil War, playing an important role in his father\'s occupation of Aberdeen in 1646, where he engaged an enemy cavalry commander in single combat and then storming the town. Going into exile after the defeat of the royalists, he traveled again to France; in rapid succession, he succeeded his brother and father as Earl of Enzie and Marquess of Gordon, and by 1651, he was allowed to return to Scotland, even though he refused to conform to the Presbyterian Church of Scotland (he was probably a Roman Catholic).\nIn 1645 Lord Lewis attacked Brodie Castle in Moray and setting it afire destroyed important archives and documents detailing the origins of the illustrious Clan Brodie. This despicable act secured Clan Brodie\'s place among the great mysteries of Scotland.\nHe died aged 26 or 27, leaving a young widow (whom he had apparently converted to Catholicism), three daughters, and a four-year-old son who would eventually become the 1st Duke of Gordon. Miles Gourdon, a cavalry commander in the French army known as the chevalier or count of "Crolis", was perhaps an illegitimate son, as he is said to have been a brother of the duke.His reputation among historians has varied; he is the clearest hero in the Civil War narrative of his kinsman Patrick Gordon of Ruthven, while John Buchan regarded him as wild and headstrong to the point of insanity.\n', 'Passage 3:\nChristopher Lambert (MP)\nChristopher Lambert, of Winchester, Hampshire, was an English politician.\nHe was the second son of William Lambert of Winchester and a servant of Sir William Paulet, 3rd Marquess of Winchester.\nLambert was a Member of Parliament for Bridport in 1593.\n', "Passage 4:\nWilliam Paulet, 3rd Marquess of Winchester\nWilliam Paulet, 3rd Marquess of Winchester  (c.\u20091532 – 24 November 1598) was an English nobleman, the son of John Paulet, 2nd Marquess of Winchester and his first wife, Elizabeth Willoughby. His maternal grandfather was Robert Willoughby, 2nd Baron Willoughby de Broke.\nHe was made a Knight of the Bath at the coronation of Mary I on 30 November 1553.\n\nCareer\nThe offices he held during his career included:\nJustice of the Peace, Hampshire from c.1559\nSheriff of Hampshire 1560–61\nJustice of the Peace, Dorset from 1564\nCommissioner for the Musters, Dorset 1569\nHigh Steward, Dorchester by 1570\nJoint Lord Lieutenant of Dorset 1569 and 1585/6-98\nMember of Parliament for Dorset 1571\nJoint Lord Lieutenant of Hampshire 1585\nLord Lieutenant of Hampshire 1585–86\nLord High Steward for the funeral of Mary, Queen of Scots, 1 August 1587\nLord Lieutenant of Hampshire 1596\nCommissioner for Ecclesiastical Causes, Diocese of Winchester 1597Paulet was summoned to Parliament on 5 May 1572 in his father's Barony of St John. He succeeded his father as 3rd Marquess of Winchester on 4 November 1576. During October 1586, he was one of the judges at the trial of Mary, Queen of Scots, later acting as Lord High Steward at her funeral on 1 August 1587.\nHe is known as the author of The Lord Marquess Idleness, a remarkable and most ingenious acrostic of six Latin verses. It was published in 1586 and 1587.\n\nMarriage and issue\nBetween 20 June 1544 and 10 February 1547/1548 he married Anne or Agnes Howard, daughter of William Howard, 1st Baron Howard of Effingham and his first wife, Katherine Broughton and had issue:\nWilliam Paulet, 4th Marquess of Winchester, died 4 February 1629, married Lucy Cecil, daughter of Thomas Cecil, 1st Earl of Exeter\nAnne Paulet, born 1552, married Sir Thomas Denys (modern spelling: Dennis), of Holcombe Burnell, Devon; grandparents of the prodigy Denys Rolle\nKatherine Paulet, married Sir Giles Wroughton\nElizabeth Paulet, married Sir Edward HobyThe marriage was not a happy one, and the couple were only reconciled, on one occasion, by Elizabeth I's intervention.Paulet also had children with his recognised mistress Jane Lambert, who later married the much younger Sir Gerrard Fleetwood:\nSir William Paulet, died 1628, lawyer, London, later of Edington, Wiltshire. High Sheriff of Wiltshire 1613, married Elizabeth, daughter of Sir John Seymour\nSir John Paulet, lawyer, Winchester, married Elizabeth, daughter of John Stump\nSir Hercules Paulet, born 1574, married Bridgett, daughter of Sir Henry Gifford\nHector Paulet, born 1578, married Joan Butler\nSusan or Susanna Paulet, married firstly Thomas Kirkby and secondly Launcelott Warnfford\n\nDeath\nHe died on 24 November 1598 and was buried at Basing, Hampshire. His widow, Anne Paulet, died on 18 November 1601. The date of Jane Lambert's death is not recorded.\n", "Passage 5:\nWilliam Paulet, 4th Marquess of Winchester\nWilliam Paulet, 4th Marquess of Winchester  (bef. 1560 – 4 February 1629) was an English nobleman, the son of William Paulet, 3rd Marquess of Winchester and Anne or Agnes Howard. He was styled Lord St. John from 1576 to 1598. He was summoned to Parliament on 16 January 1581 in his father's barony as Lord St. John. On 24 November 1598, he succeeded his father as 4th Marquess of Winchester. Paulet experienced great financial difficulties arising from his magnificent style of living and his lavish entertainment of Elizabeth I at Basing House.\n\nMarriage and issue\nOn 28 February 1587 at St Martin-in-the-Fields, he married Lady Lucy Cecil, daughter of Sir Thomas Cecil, 1st Earl of Exeter and his first wife, Dorothy Neville. Lucy and William had six children:\nWilliam Paulet, Lord St John (1587/8–1621), married Mary Browne, daughter of Anthony-Maria Browne, 2nd Viscount Montagu\nThomas Paulet, died before 1621\nJohn Paulet, 5th Marquess of Winchester (c.1598–5 March 1675) married three times:\nJane Savage, daughter of Thomas Savage, 1st Viscount Savage\nHonora de Burgh, daughter of Richard Burke, 4th Earl of Clanricarde\nIsabel Howard, daughter of William Howard, 1st Viscount Stafford and Mary Stafford\nLord Henry Paulet, of Amport, married Lucy Philpot, daughter of Sir George Philpot of Thruxton\nCharles Paulet, died c.1654, had issue\nEdward PauletHis wife, Lucy, was treated for cancer in 1614 by the court physician Théodore de Mayerne. She died 1 October 1614 and was buried a month later in the Cecil vault in Westminster Abbey.\n\nDeath\nWilliam Paulet died at Hackwood, near Basingstoke, on 4 February 1629, and was buried at Basing, Hampshire.\n\nFootnotes\nSources\nExternal links\nWilliam Paulet, Marquess of Winchester Family tree\nHistory of Basing House\n", 'Passage 6:\nArchibald Kennedy, 3rd Marquess of Ailsa\nArchibald Kennedy, 3rd Marquess of Ailsa (1 September 1847 – 9 April 1938) was a Scottish peer.\n\nEarly life\nArchibald was born on 1 September 1847, the eldest of three sons born to Julia (née Jephson), Marchioness of Ailsa, and Archibald Kennedy, 2nd Marquess of Ailsa. Among his siblings was Maj Lord Alexander Kennedy, Lord John Kennedy, Lady Julia Alice Kennedy, Lady Evelyn Anne Kennedy, and Lady Constance Eleanor Kennedy.His father was the eldest son of Archibald Kennedy, Earl of Cassilis, himself the oldest son of Archibald Kennedy, 1st Marquess of Ailsa.  His mother was the second daughter of Sir Richard Jephson, 1st Baronet and the former Charlotte Rochfort Smith.\n\nCareer\nAs a young man, he served as an officer in the Coldstream Guards. In 1885, he founded the Ailsa Shipbuilding Company, which was based in Troon and Ayr, Ayrshire.\n\nPeerage\nUpon the death of his father on 20 March 1870, he succeeded to the titles of 14th Earl of Cassilis, 16th Lord Kennedy, 3rd Marquess of Ailsa and 3rd Baron Ailsa. Along with the title came 76,000 acres in Ayrshire. He held the office of Lord-Lieutenant of Ayrshire between 1919 and 1937.\n\nPersonal life\nLord Ailsa was twice married. His first marriage took place on 7 March 1871 to Hon. Evelyn Stuart, daughter of Charles Stuart, 12th Lord Blantyre and Lady Evelyn Sutherland-Leveson-Gower (herself a daughter of George Sutherland-Leveson-Gower, 2nd Duke of Sutherland). Together, they were the parents of five children:\nArchibald Kennedy, 4th Marquess of Ailsa (1872–1943), who married Frances Stewart, daughter of Sir Mark MacTaggart-Stewart, 1st Baronet.\nCharles Kennedy, 5th Marquess of Ailsa (1875–1956), who married Constance Clarke, widow of Sir John Baird.\nLady Evelyn Kennedy (1876–1886), who died young.\nLady Aline Kennedy (1877–1957), who married John Edward Browne, 5th Baron Kilmaine (1878–1946) in 1901.\nAngus Kennedy, 6th Marquess of Ailsa (1882–1957), who married Gertrude Millicent Cooper.He married secondly on 3 November 1891 to Isabella MacMaster, the only daughter of Hugh MacMaster, a market gardener of Kausani, India. Together, they had two more children:\nLt.-Col. Lord Hugh Kennedy (1895–1970), who married Katharine Louisa Clare Atherton, daughter of Francis Henry Atherton.\nLady Marjory Kennedy (b. 1898), who married Sir Laurence Pierce Brooke Merriam, MC.Lord Ailsa died at his home, Culzean Castle, overlooking the Firth of Clyde where he was known as one of the foremost floriculturists, on 9 April 1938.\n\nSailing\nHe was a keen sailor, having studied navigation, and had William Fife build him Foxhound in 1870, Bloodhound in 1874 and Sleuthhound in 1881. He had his own shipyard at Culzean Castle, where he built the 5-ton Cocker.\n', 'Passage 7:\nRichard Paulet, 17th Marquess of Winchester\nRichard Charles Paulet, 17th Marquess of Winchester (born on 8 July 1905; died 5 March 1968) was the son of Charles Standish Paulet and Lillian Jane Charlotte Fosbery. He was the great-grandson of Lord Charles Paulet, a younger son of the 13th Marquess. He inherited the title from Henry Paulet, 16th Marquess of Winchester, in 1962. He died unmarried, and the title was passed to his cousin Nigel Paulet, 18th Marquess of Winchester.\n', 'Passage 8:\nWilliam Paulet, 1st Marquess of Winchester\nWilliam Paulet, 1st Marquess of Winchester  (c. 1483/1485 – 10 March 1572), styled Lord St John between 1539 and 1550 and Earl of Wiltshire between 1550 and 1551, was an English Lord High Treasurer, Lord Keeper of the Great Seal, and statesman.\n\nFamily origins and early career in Hampshire\nPaulet was the eldest son of Sir John Paulet (1460 – 5 January 1525) of Basing Castle in the parish of Old Basing, near Basingstoke in Hampshire, and of Nunney Castle in Somerset (inherited from the Delamere family in 1415), a cadet branch of Paulet of Hinton St George in Somerset. His mother Alice Paulet was his father\'s second cousin-once-removed the daughter of Sir William Paulet by his wife Elizabeth Denebaud. William had six siblings, including Sir George Paulet of Crondall Manor in Hampshire and Eleanor Paulet (born 1479), wife of William Giffard of Itchell Manor at Ewshot, also in Hampshire.\nThe family originated at the manor of Paulet (now Pawlett), near Bridgwater in Somerset. The senior branch of the Paulet/Powlet/Poulett family was seated at Hinton St George in Somerset, and had lived in that county since the early thirteenth century; the first Member of Parliament from that line represented Devon in 1385.There is some disagreement over his date of birth, with different authorities quoting 1483 or 1485. A claim that he was ninety-seven at his death would place his birth in 1474 or 1475. There is also uncertainty about where he was born, but it may have been at Fisherton Delamere in Wiltshire, one of his father\'s manors.His father, who had held a command against the Cornish rebels in 1497, was the head of the branch seated at Paulet and Road, close to Bridgwater, being the son of John Paulet and Elizabeth Roos. William\'s great-grandfather John Paulet acquired the Hampshire estates by his marriage with Constance Poynings, granddaughter and coheiress of Thomas Poynings, 5th Baron St John of Basing; his barony became abeyant upon his death in 1428/1429.\nWilliam Paulet was High Sheriff of Hampshire in 1512, 1519, 1523, and again in 1527. Knighted before the end of 1525, he was appointed Master of the King\'s Wards in November 1526 and appeared in the Privy Council in the same year.\n\nMarriage and issue\nHe married Elizabeth (d. 25 December 1558), daughter of Sir William Capel, Lord Mayor of London in 1503, and by her had four sons and four daughters:\nJohn Paulet, 2nd Marquess of Winchester\nThomas\nChidiock Paulet (also spelled Chidiok, Chediok, Chidieok, or Chidiock), governor of Southampton under Mary and Elizabeth\nGiles\nAlice, married Richard Stawell, of Cotherston, Somerset\nMargaret, married Sir William Berkeley\nMargery, married Sir Richard Waller, of Oldstoke, Hampshire\nEleanor (died 26 September 1558), married Sir Richard Pecksall (died 1571) of Beaurepaire, Hampshire, hereditary Master of the Buckhounds.\n\nCareer as a national statesman\nDuring his long career Paulet held numerous offices, which included:\nHigh Sheriff of Hampshire 1511–12, 1518–19 and 1522–23\nJoint Master of the King\'s Wards 1526–34 and sole Master of the King\'s Wards 1534–40\nMember of Parliament for Hampshire 1529–36\nComptroller of the Household 1532–37\nKeeper of Pamber Forest 1535/6\nTreasurer of the Household 1537–38/9\nMaster of the King\'s Woods 1541\nMaster of the Court of Wards 1540–42\nMaster of the Court of Wards and Liveries 1542–54\nPrivy Counsellor 1542\nLord Chamberlain of the Household 1543–45\nLord Steward of the Household 1545-1549/50\nChief Justice in Eyre, South of Trent 1545–49/50\nLord President of the Council 1546–49\nJoint Governor of King Edward VI\nLord Keeper of the Great Seal 1547\nKeeper and Captain of St Andrew\'s Castle, Hamble 1547–71/2\nKeeper of Alice Holt and Woolmer Forests 1548–71/2\nLord High Treasurer 1549/50–71/2\nLord High Steward for the trial of the Duke of Somerset 1551\nLord Lieutenant of Hampshire 1552, 1553 and 1559\nLieutenant of the forces in London 1558\nSpeaker of the House of Lords 1558 and 1566\nLord Lieutenant of Hampshire and Middlesex 1569\nJoint Lord Lieutenant of London 1569Paulet\'s political career began in 1529, when he was elected knight of the shire for Hampshire. In 1532, he accompanied King Henry VIII to Calais, France, and the following spring, he accompanied the Duke of Norfolk to join King Francis I of France in a proposed audience with the Pope, to discuss Henry\'s divorce from Catherine of Aragon. In 1536, he was granted the keepership of Pamber Forest, and on 9 March 1539 was created Baron St John. He became steward of the bishopric of Winchester, and became a close associate of Cardinal Thomas Wolsey and a friend of Thomas Cromwell. He was also Comptroller of the Royal Household, and held many other high positions.\nIn 1535 and 1536, he served as one of the judges for the trials of John Fisher, Sir Thomas More, and the alleged accomplices of Anne Boleyn; in 1535, he became Lord Chamberlain. He partially led the royal forces against the Pilgrimage of Grace, a rebellion that broke out in the autumn of 1536, and in 1538, he became Treasurer of the Household. In 1540, he became the master of Henry\'s Court of Wards and Liveries, a Knight of the Garter in 1543, and Governor of Portsmouth and Lord Steward of the Household in 1545. In 1546, he became Lord President of the Council, and in 1547, he was an executor of the will of King Henry VIII.He continued his political manoeuvres in 1549 by supporting the Earl of Warwick against the Duke of Somerset—in reward, on 19 January 1550 he was given the Earldom of Wiltshire and Somerset\'s position of Lord Treasurer. In the following month Warwick took over the post of Lord President of the Council. When Warwick was created Duke of Northumberland on 11 October 1551, Paulet received the Marquessate of Winchester. Six weeks later, he served as Lord High Steward in the Duke of Somerset\'s trial.\nIt was said that Northumberland and Winchester "ruled the court" of the minor King Edward VI. Mary I affirmed him in all of his positions. After her death, he remained Lord Treasurer and retained many of his other positions, and even at an advanced age (in 1559, he was over seventy years old), he showed no signs of declining—he was Speaker of the House of Lords in 1559 and 1566. He remained in good standing with the English monarchs—Queen Elizabeth once joked, "for, by my troth, if my lord treasurer were but a young man, I could find it in my heart to have him for a husband before any man in England." Late in life, he opposed any military support of Continental Protestantism, as he feared it would cause a breach with strongly Catholic Spain.\nPaulet enjoyed a remarkably long career during the Reformation. Starting out as a Catholic, he was quickly persuaded to see things Henry\'s way once the breach with Rome had been decided on. He was rewarded with former Church properties following the dissolution of the monasteries. Under Edward VI he became an evangelical Protestant and persecuted Roman Catholics and Henrician Conservatives alike. On the accession of the Catholic Mary he announced his reconversion and commenced persecuting his former Protestant co-religionists, even denouncing Bishop Bonner for "laxity in prosecuting the heretics." His wife also found favour with Mary. On Tuesday 21 August 1554, when Mary went into Westminster Abbey her train was carried by Elizabeth, Marchioness of Winchester and Anne of Cleves.On Elizabeth\'s succession, he once again shifted his sails and became an advocate of middle-road Anglicanism. All in all, he professed five changes in religious course. Once, when asked how he managed to survive so many storms, not only unhurt, but rising all the while, Paulet answered: "By being a willow, not an oak".\n\nDeath\nPaulet was still in office when he died on 10 March 1572, a very old man, at Basing House, which he held to rebuild and fortify. His tomb is on the south side of the chancel of Basing church.\n', 'Passage 9:\nJohn Paulet, 5th Marquess of Winchester\nJohn Paulet, 5th Marquess of Winchester (c. 1598 – 5 March 1675), styled Lord John Paulet until 1621 and Lord St John from 1621 to 1628, was the third but eldest surviving son of William Paulet and his successor as 5th Marquess of Winchester.\n\nLife\nHe kept terms at Exeter College, Oxford, but as a Roman Catholic could not matriculate. He sat for St Ives from 1620 to 1622. Staying away to recover his family fortune for most of the 1630s, he returned and presented himself to the court and the king in 1639. The fifth Marquess and the Queen became firm friends thereafter, and therefore his chief seat, Basing House, was the great resort of Queen Henrietta Maria\'s friends in southwest England.On the outbreak of the English Civil War, he fortified and garrisoned Basing House and held it for Charles I during 1643 and 1644. The siege of Basing House, notwithstanding an attempt of his youngest brother, Lord Edward Paulet, to deliver it up to the enemy, lasted from August 1643 to 16 October 1645, when, during the general decline of the Royal cause, it was taken by storm, after a determined defence, by Oliver Cromwell. The brutality with which the house was sacked was most unusual, as atrocities against civilians during the Civil War were rare and generally discouraged by both sides: the explanation may be the presence of a number of Catholic priests among the defenders. Paulet was subsequently renowned as a great loyalist.The Marquess was made prisoner with such of his garrison as survived the fight; ten pieces of ordnance and much ammunition were also taken by the victors, as Oliver Cromwell himself, who directed the assault, wrote to the Speaker.He was committed to the Tower of London on a charge of high treason in 1645, where he remained a long time; an order was made for allowing him 5l. a week out of his property on 15 Jan 1646. Lady Winchester, who had escaped from Basing two days before its fall, was sent to join her husband in the Tower on 31 Jan, and a weekly sum of 10l., afterwards increased to 15l., was ordered to be paid her for the support of herself and her children, with the stipulation that the latter were to be educated as Protestants. An ordinance for the sale of Winchester\'s land was passed on 30 Oct, and by the act of 16 July 1651, a portion was sold by the trustees for the sale of forfeited estates. On 7 September 1647 Winchester was allowed to drink the waters at Epsom, and stayed there by permission of parliament for nearly six months. The House of Lords on 30 June 1648 urged the commons to release him on bail in consideration of his bad health. In the propositions sent to the king at the Isle of Wight on 13 October, it was expressly stipulated that Winchester\'s name be excepted from pardon. Ultimately the commons resolved on 14 March 1649 not to proceed against him for high treason, but they ordered him to be detained in prison and excepted from any composition for his estate. In January 1656 he was a prisoner in execution in the upper bench for debts amounting to 2,000l., and he petitioned Cromwell for relief. The sale of his lands was discontinued by order of parliament on 15 March 1660, and after the Restoration Winchester received them back. It was proposed on 3 August 1660 to recompense him for his losses to the amount of 19,000l. and damages, subsequently reduced to 10,000l., and this was agreed to on 2 July 1661. In the event he was allowed to go unrecompensed at the Restoration of the Monarchy, but regained his lands.\n\nMarriages and issue\nHe married as his first wife:\nJane Savage, daughter of Thomas Savage, 1st Viscount Savage of Rocksavage, on 18 December 1622, and by her had a son:Charles Paulet, 1st Duke of Bolton, born c. 1630\nJane died in childbirth in 1631, prompting an epitaph by John MiltonHe married as his second wife:\n\nHonora de Burgh, born c. 1605, daughter of Richard Burke, 4th Earl of Clanricarde and Frances Walsingham, in around 1645 and by her, had a daughter:Anne, died c. September 1694, married John Belasyse, 1st Baron BelasyseHe married as his third wife:\n\nIsabel Howard, daughter of William Howard, 1st Viscount Stafford and Mary Stafford, sister of the 5th Baron Stafford, in 1669.\n\nDeath\nHe retired to Englefield House in Berkshire, which was a wedding gift from his second marriage to Lady Honora de Burgh in the early 1630s. He died on 5 March 1674 and was buried at Englefield, Berkshire. Paulet was succeeded, by his eldest son, Charles Paulet, as 6th Marquess of Winchester, later created 1st Duke of Bolton. Charles converted to the Church of England, a great blow to the Roman Catholic community of Hampshire, who had for many years looked to the Paulet family to shield them from the worst rigours of the Penal Laws.\n\nFootnotes\nAttribution This article incorporates text from this source, which is in the public domain: "The Genealogy of the Existing British Peerage" by Edmund Lodge (1859)\n This article incorporates text from this source, which is in the public domain: Goodwin, Gordon (1895). "Paulet, John" .  In Lee, Sidney (ed.). Dictionary of National Biography. Vol. 44. London: Smith, Elder & Co. pp. 90–92.\n\nSources\nExternal links\nJohn Paulet, Marquess of Winchester A family tree\nRoyal Berkshire History: John Paulet\nPortraits of John Paulet, 5th Marquess of Winchester at the National Portrait Gallery, London \nJohn Paulet\nHistory of Basing House\n', "Passage 10:\nJohn Paulet, 2nd Marquess of Winchester\nJohn Paulet, 2nd Marquess of Winchester (c.\u20091510 – 4 November 1576), styled The Honourable John Paulet between 1539 and 1550, Lord St John between 1550 and 1551 and Earl of Wiltshire between 1551 and 1555, was an English peer. He was the eldest son of William Paulet, 1st Marquess of Winchester and Elizabeth Capel.\n\nCareer\nJohn Paulet was knighted by Henry VIII at Boulogne on 30 September 1544. After the death of Edward VI he was (with his father) one of the signatories to the settlement of the Crown on Lady Jane Grey of 16 June 1553, although he later changed his allegiance to Queen Mary. He was styled Lord St John from 1550 to 1572. He was summoned to Parliament on 3 October 1554 in one of his father's baronies as Lord St John. He was one of the Peers at the trial of the Duke of Norfolk on 16 January 1572. He succeeded his father as Marquess of Winchester on 10 March 1572.The offices he held during his career included:\nHigh Sheriff of Hampshire 1533–34\nHigh Sheriff of Somerset and Dorset 1543–44\nSteward of Canford castle 1549/50\nConstable of Corfe Castle 1549/50\nLord Lieutenant of Dorset 1557\nGovernor of the Isle of Wight 1558\nKeeper of St Andrew's Castle, Hamble 1572–1576\n\nMarriages and issue\nPaulet was married three times:\nHe married as his first wife, by 20 October 1528, Elizabeth, daughter of Robert Willoughby, 2nd Baron Willoughby de Broke by his second wife, Dorothy, daughter of Thomas Grey, 1st Marquess of Dorset, and by her had four sons and two daughters:William Paulet, 3rd Marquess of Winchester (c.\u20091532 – 24 November 1598)\nGeorge Paulet\nRichard Paulet\nThomas Paulet\nElizabeth Paulet, married firstly Sir William Courtenay of Powderham and secondly Sir Henry Ughtred\nMary Paulet (died 10 October 1592), married Henry Cromwell, 2nd Baron CromwellHe married secondly, between 10 March and 24 April 1554, Elizabeth Seymour, daughter of Sir John Seymour and Margery Wentworth, and widow of Gregory Cromwell, 1st Baron Cromwell.\nHe married thirdly, before 30 September 1568, Winifred, widow of Sir Richard Sackville, and daughter of John Brydges, a former Lord Mayor of London. He succeeded his father as Marquess of Winchester in 1572.\n\nDeath\nJohn Paulet died at Chelsea on 4 November 1576 and was buried in St. Mary's Church, Basing, Hampshire. His widow, Winifred, died at Chelsea in 1586 and was buried in Westminster Abbey."
    ]
    query = "What is the date of birth of William Paulet, 3Rd Marquess Of Winchester's father?\n\nAnswer:"



    device = torch.device(f'cuda:0')
    tokenizer, model = load_model_and_tokenizer(args.model, device)
    model = model.eval()
    tokenizer.pad_token_id = tokenizer.eos_token_id
    prefix = build_prefix(args.model, prefix)
    query = build_suffix(args.model, query)
    with torch.no_grad():
        prefix_input_ids = tokenizer(prefix, truncation=False, return_tensors="pt", add_special_tokens=False).input_ids
        query_input_ids = tokenizer(query, truncation=False, return_tensors="pt").input_ids
        len_prefix = prefix_input_ids.shape[1]
        len_query = query_input_ids.shape[1]

        context_input_ids = tokenizer(contexts, return_tensors='pt', truncation=True, max_length=8192-len_prefix-len_query-256, padding=True, add_special_tokens=False).input_ids
        print(context_input_ids.shape)
        context_mask = (context_input_ids != tokenizer.pad_token_id).reshape(-1)
        
        enable_attention_prefill_prefix(args.model, model)
        past_key_values = None
        outputs = model(
            prefix_input_ids.to(model.device),
            past_key_values=past_key_values,
            use_cache=True,
        )

        past_key_values = []
        for past_key_value in outputs.past_key_values:
            bsz, _ = context_input_ids.shape
            past_key = past_key_value[0].repeat(bsz, 1, 1, 1)
            past_value = past_key_value[1].repeat(bsz, 1, 1, 1)
            past_position = past_key_value[2]
            past_key_values.append((past_key, past_value, past_position))

        enable_attention_prefill_context(args.model, model)
        outputs = model(
            context_input_ids.to(model.device),
            past_key_values=past_key_values,
            use_cache=True,
        )
        past_key_values = []

        for past_key_value in outputs.past_key_values:
            bsz, num_heads, seq_len, _ = past_key_value[0].size()
            past_key = torch.cat([past_key_value[0][:1, :, :len_prefix, :], 
                                    past_key_value[0][:, :, len_prefix:, :].transpose(1, 2).flatten(0, 1)[context_mask].unsqueeze(0).transpose(1, 2)], dim=2)
            past_value = torch.cat([past_key_value[1][:1, :, :len_prefix, :], 
                                    past_key_value[1][:, :, len_prefix:, :].transpose(1, 2).flatten(0, 1)[context_mask].unsqueeze(0).transpose(1, 2)], dim=2)  
            past_position = torch.cat([past_key_value[2][:, :len_prefix],
                                        past_key_value[2][:, len_prefix:].repeat(bsz, 1).flatten()[context_mask].unsqueeze(0)], dim=1)
            past_key_values.append((past_key, past_value, past_position, len(contexts)))
        context_input_ids = context_input_ids.flatten()[context_mask].unsqueeze(0)
        input_ids = torch.cat([prefix_input_ids, context_input_ids, query_input_ids], dim=-1)
        context_length = input_ids.shape[-1]

        enable_attention_prefill_query(args.model, model, args.temperature, args.scale)
        output = model.generate(
            input_ids=input_ids.to(model.device),
            max_new_tokens=256,
            num_beams=1,
            do_sample=False,
            temperature=1.0,
            past_key_values=past_key_values,
        )[0]
        pred = tokenizer.decode(output[context_length:], skip_special_tokens=True)
        print(pred)

if __name__ == '__main__':
    args = parse_args()
    seed_everything(42)
    generate(args)
    